<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qu·∫£n l√Ω Th√¥ng b√°o</title>
  <link rel="stylesheet" href="/css/notification.css" />
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: flex-start; align-items: center; gap: 20px;">
        <button id="backBtn" class="back-btn">‚Üê Tr·ªü v·ªÅ Home</button>
        <div style="flex: 1;">
          <h1>üì¨ Qu·∫£n l√Ω Th√¥ng b√°o</h1>
          <p>T·∫°o, g·ª≠i v√† qu·∫£n l√Ω th√¥ng b√°o cho ng∆∞·ªùi d√πng</p>
        </div>
      </div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="send-all">G·ª≠i cho T·∫•t c·∫£</button>
      <button class="tab-btn" data-tab="send-single">G·ª≠i cho 1 User</button>
      <button class="tab-btn" id="managementLink">üìã Qu·∫£n l√Ω Th√¥ng b√°o</button>
    </div>

    <!-- Tab 1: G·ª≠i cho t·∫•t c·∫£ -->
    <div id="send-all" class="tab-content active">
      <div class="form-section">
        <h2>üì¢ G·ª≠i th√¥ng b√°o cho T·∫•t c·∫£ Users</h2>
        <p style="color: #666; margin-bottom: 16px;">Th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ªõi t·∫•t c·∫£ ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng k√Ω trong h·ªá th·ªëng.</p>
        <form id="broadcastForm">
          <div class="row">
            <div class="form-group">
              <label>Lo·∫°i *</label>
              <select id="broadcastType">
                <option value="info">‚ÑπÔ∏è Info</option>
                <option value="success">‚úÖ Success</option>
                <option value="warning">‚ö†Ô∏è Warning</option>
                <option value="error">‚ùå Error</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Ti√™u ƒë·ªÅ *</label>
            <input type="text" id="broadcastTitle" placeholder="V√≠ d·ª•: B·∫£o tr√¨ h·ªá th·ªëng" required />
          </div>
          <div class="form-group">
            <label>N·ªôi dung *</label>
            <textarea id="broadcastMessage" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..." required></textarea>
          </div>
          <div class="form-group">
            <label>D·ªØ li·ªáu b·ªï sung (JSON - kh√¥ng b·∫Øt bu·ªôc)</label>
            <textarea id="broadcastData" placeholder='{"key":"value"}'></textarea>
          </div>
          <button type="submit" class="btn-primary">G·ª≠i cho T·∫•t c·∫£</button>
        </form>
        <div id="broadcastResponse"></div>
      </div>
    </div>

    <!-- Tab 2: G·ª≠i cho 1 user -->
    <div id="send-single" class="tab-content">
      <div class="form-section">
        <h2>üì§ G·ª≠i th√¥ng b√°o cho 1 User</h2>
        <form id="singleForm">
          <div class="row">
            <div class="form-group">
              <label>Wallet Address *</label>
              <input type="text" id="walletAddress" placeholder="0x..." required />
            </div>
            <div class="form-group">
              <label>Lo·∫°i *</label>
              <select id="type">
                <option value="info">‚ÑπÔ∏è Info</option>
                <option value="success">‚úÖ Success</option>
                <option value="warning">‚ö†Ô∏è Warning</option>
                <option value="error">‚ùå Error</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Ti√™u ƒë·ªÅ *</label>
            <input type="text" id="title" placeholder="V√≠ d·ª•: C·∫≠p nh·∫≠t t√†i kho·∫£n" required />
          </div>
          <div class="form-group">
            <label>N·ªôi dung *</label>
            <textarea id="message" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..." required></textarea>
          </div>
          <div class="form-group">
            <label>D·ªØ li·ªáu b·ªï sung (JSON - kh√¥ng b·∫Øt bu·ªôc)</label>
            <textarea id="data" placeholder='{"key":"value"}'></textarea>
          </div>
          <button type="submit" class="btn-primary">G·ª≠i Th√¥ng b√°o</button>
        </form>
        <div id="singleResponse"></div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.dataset.tab) {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        }
      });
    });

    const apiBase = '/api/notification';

    // Single notification form
    document.getElementById('singleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const responseDiv = document.getElementById('singleResponse');
      responseDiv.innerHTML = '';

      const payload = {
        walletAddress: document.getElementById('walletAddress').value.trim(),
        title: document.getElementById('title').value.trim(),
        message: document.getElementById('message').value.trim(),
        type: document.getElementById('type').value,
      };

      const dataRaw = document.getElementById('data').value.trim();
      if (dataRaw) {
        try { payload.data = JSON.parse(dataRaw); } 
        catch(err) { 
          responseDiv.className = 'response error';
          responseDiv.innerHTML = `<strong>‚ùå JSON kh√¥ng h·ª£p l·ªá:</strong> ${err.message}`; 
          return; 
        }
      }

      try {
        const res = await fetch(`${apiBase}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        responseDiv.className = `response ${res.ok ? 'success' : 'error'}`;
        responseDiv.innerHTML = `<strong>${res.ok ? '‚úÖ' : '‚ùå'} ${json.message}</strong><pre>${JSON.stringify(json, null, 2)}</pre>`;
        if (res.ok) document.getElementById('singleForm').reset();
      } catch (err) {
        responseDiv.className = 'response error';
        responseDiv.innerHTML = `<strong>‚ùå L·ªói:</strong> ${err.message}`;
      }
    });

    // Broadcast form
    document.getElementById('broadcastForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const responseDiv = document.getElementById('broadcastResponse');
      responseDiv.innerHTML = '';

      const payload = {
        title: document.getElementById('broadcastTitle').value.trim(),
        message: document.getElementById('broadcastMessage').value.trim(),
        type: document.getElementById('broadcastType').value,
      };

      const dataRaw = document.getElementById('broadcastData').value.trim();
      if (dataRaw) {
        try { payload.data = JSON.parse(dataRaw); } 
        catch(err) { 
          responseDiv.className = 'response error';
          responseDiv.innerHTML = `<strong>‚ùå JSON kh√¥ng h·ª£p l·ªá:</strong> ${err.message}`; 
          return; 
        }
      }

      try {
        const res = await fetch(`${apiBase}/send-all`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        responseDiv.className = `response ${res.ok ? 'success' : 'error'}`;
        responseDiv.innerHTML = `<strong>${res.ok ? '‚úÖ' : '‚ùå'} ${json.message}</strong><pre>${JSON.stringify(json, null, 2)}</pre>`;
        if (res.ok) document.getElementById('broadcastForm').reset();
      } catch (err) {
        responseDiv.className = 'response error';
        responseDiv.innerHTML = `<strong>‚ùå L·ªói:</strong> ${err.message}`;
      }
    });

    // Management link
    document.getElementById('managementLink').addEventListener('click', () => {
      window.location.href = '/api/notification/management/ui';
    });

    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = '/';
    });
  </script>
</body>
</html>
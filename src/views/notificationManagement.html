<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quáº£n lÃ½ ThÃ´ng bÃ¡o</title>
  <link rel="stylesheet" href="/css/notificationManagement.css" />
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: flex-start; align-items: center; gap: 20px;">
        <button id="backBtn" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; flex-shrink: 0;">â† Trá»Ÿ vá»</button>
        <div style="flex: 1;">
          <h1>ğŸ“¬ Quáº£n lÃ½ ThÃ´ng bÃ¡o (NhÃ¡p & ÄÃ£ Gá»­i)</h1>
          <p>Táº¡o báº£n nhÃ¡p, quáº£n lÃ½ vÃ  gá»­i thÃ´ng bÃ¡o cho ngÆ°á»i dÃ¹ng</p>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="create-draft">Táº¡o Báº£n NhÃ¡p</button>
      <button class="tab-btn" data-tab="drafts-list">Danh sÃ¡ch NhÃ¡p</button>
      <button class="tab-btn" data-tab="sent-list">ÄÃ£ Gá»­i</button>
      <button class="tab-btn" data-tab="stats">Thá»‘ng kÃª</button>
    </div>

    <!-- Tab 1: Táº¡o báº£n nhÃ¡p -->
    <div id="create-draft" class="tab-content active">
      <div class="form-section">
        <h2>âœï¸ Táº¡o Báº£n NhÃ¡p ThÃ´ng bÃ¡o</h2>
        <form id="draftForm">
          <div class="form-group">
            <label>Loáº¡i Gá»­i *</label>
            <select id="draftRecipientType" required>
              <option value="all">ğŸ“¢ Gá»­i cho Táº¥t cáº£ Users</option>
              <option value="single">ğŸ‘¤ Gá»­i cho 1 User</option>
            </select>
          </div>

          <div class="form-group" id="walletGroup" style="display: none;">
            <label>Wallet Address *</label>
            <input type="text" id="draftWallet" placeholder="0x..." />
          </div>

          <div class="row">
            <div class="form-group">
              <label>Loáº¡i ThÃ´ng bÃ¡o *</label>
              <select id="draftType" required>
                <option value="info">â„¹ï¸ Info</option>
                <option value="success">âœ… Success</option>
                <option value="warning">âš ï¸ Warning</option>
                <option value="error">âŒ Error</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>TiÃªu Ä‘á» *</label>
            <input type="text" id="draftTitle" placeholder="Nháº­p tiÃªu Ä‘á» thÃ´ng bÃ¡o" required />
          </div>

          <div class="form-group">
            <label>Ná»™i dung *</label>
            <textarea id="draftMessage" placeholder="Nháº­p ná»™i dung thÃ´ng bÃ¡o..." required></textarea>
          </div>

          <div class="form-group">
            <label>Dá»¯ liá»‡u bá»• sung (JSON - khÃ´ng báº¯t buá»™c)</label>
            <textarea id="draftData" placeholder='{"key":"value"}'></textarea>
          </div>

          <button type="submit" class="btn-primary">ğŸ’¾ LÆ°u Báº£n NhÃ¡p</button>
        </form>
        <div id="draftResponse"></div>
      </div>
    </div>

    <!-- Tab 2: Danh sÃ¡ch báº£n nhÃ¡p -->
    <div id="drafts-list" class="tab-content">
      <div class="form-section">
        <h2>ğŸ“‹ Danh sÃ¡ch Báº£n NhÃ¡p</h2>
        <div class="filter-section">
          <select id="filterStatus">
            <option value="">Táº¥t cáº£ Tráº¡ng thÃ¡i</option>
            <option value="draft">NhÃ¡p</option>
            <option value="scheduled">LÃªn lá»‹ch</option>
            <option value="sent">ÄÃ£ gá»­i</option>
          </select>
          <select id="filterRecipient">
            <option value="">Táº¥t cáº£ Loáº¡i</option>
            <option value="all">Gá»­i cho Táº¥t cáº£</option>
            <option value="single">Gá»­i cho 1 User</option>
          </select>
          <button class="btn-primary btn-small" id="loadDraftsBtn">ğŸ”„ Táº£i Danh sÃ¡ch</button>
        </div>
        <div id="draftsContainer"></div>
      </div>
    </div>

    <!-- Tab 3: ThÃ´ng bÃ¡o Ä‘Ã£ gá»­i -->
    <div id="sent-list" class="tab-content">
      <div class="form-section">
        <h2>âœ‰ï¸ Táº¥t cáº£ ThÃ´ng bÃ¡o (ÄÃ£ Gá»­i & ChÆ°a Äá»c)</h2>
        <div class="filter-section">
          <button class="btn-primary btn-small" id="loadAllNotificationsBtn">ğŸ”„ Táº£i Táº¥t cáº£ ThÃ´ng bÃ¡o</button>
        </div>
        <div id="allNotificationsContainer"></div>
      </div>
    </div>

    <!-- Tab 4: Thá»‘ng kÃª -->
    <div id="stats" class="tab-content">
      <div class="form-section">
        <h2>ğŸ“Š Thá»‘ng kÃª ThÃ´ng bÃ¡o</h2>
        <button class="btn-primary btn-small" id="loadStatsBtn">ğŸ”„ Táº£i Thá»‘ng kÃª</button>
        <div id="statsContainer" class="stats" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <script>
    const apiBase = '/api/notification-draft';
    const notifApiBase = '/api/notification';

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // Toggle wallet field based on recipient type
    document.getElementById('draftRecipientType').addEventListener('change', (e) => {
      const walletGroup = document.getElementById('walletGroup');
      const draftWallet = document.getElementById('draftWallet');
      if (e.target.value === 'single') {
        walletGroup.style.display = 'block';
        draftWallet.required = true;
      } else {
        walletGroup.style.display = 'none';
        draftWallet.required = false;
        draftWallet.value = '';
      }
    });

    // Create draft form
    document.getElementById('draftForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const responseDiv = document.getElementById('draftResponse');
      responseDiv.innerHTML = '';

      const payload = {
        title: document.getElementById('draftTitle').value.trim(),
        message: document.getElementById('draftMessage').value.trim(),
        type: document.getElementById('draftType').value,
        recipientType: document.getElementById('draftRecipientType').value,
        walletAddress: document.getElementById('draftWallet').value.trim() || null,
        data: {}
      };

      const dataRaw = document.getElementById('draftData').value.trim();
      if (dataRaw) {
        try {
          payload.data = JSON.parse(dataRaw);
        } catch (err) {
          responseDiv.className = 'response error';
          responseDiv.innerHTML = `<strong>âŒ JSON khÃ´ng há»£p lá»‡:</strong> ${err.message}`;
          return;
        }
      }

      try {
        const res = await fetch(apiBase, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        responseDiv.className = `response ${res.ok ? 'success' : 'error'}`;
        responseDiv.innerHTML = `<strong>${res.ok ? 'âœ…' : 'âŒ'} ${json.message}</strong><pre>${JSON.stringify(json, null, 2)}</pre>`;
        if (res.ok) {
          document.getElementById('draftForm').reset();
          setTimeout(() => loadDrafts(), 1000);
        }
      } catch (err) {
        responseDiv.className = 'response error';
        responseDiv.innerHTML = `<strong>âŒ Lá»—i:</strong> ${err.message}`;
      }
    });

    // Load drafts
    async function loadDrafts() {
      const container = document.getElementById('draftsContainer');
      container.innerHTML = '<div class="loading"><span class="spinner"></span> Äang táº£i...</div>';

      const status = document.getElementById('filterStatus').value;
      const recipientType = document.getElementById('filterRecipient').value;
      const params = new URLSearchParams();
      if (status) params.append('status', status);
      if (recipientType) params.append('recipientType', recipientType);

      try {
        const res = await fetch(`${apiBase}?${params.toString()}`);
        const data = await res.json();

        if (!res.ok) {
          container.innerHTML = `<div class="response error"><strong>âŒ ${data.message}</strong></div>`;
          return;
        }

        const { drafts = [] } = data;
        if (drafts.length === 0) {
          container.innerHTML = '<div class="response"><strong>KhÃ´ng cÃ³ báº£n nhÃ¡p</strong></div>';
          return;
        }

        let html = '<div class="items-list">';
        drafts.forEach(draft => {
          const date = new Date(draft.createdAt).toLocaleString('vi-VN');
          const statusBadge = `badge-${draft.status}`;
          const typeBadge = `badge-${draft.type}`;
          html += `
            <div class="item-card">
              <div class="item-header">
                <div>
                  <div class="item-title">${draft.title}</div>
                  <span class="item-badge ${statusBadge}">${draft.status.toUpperCase()}</span>
                  <span class="item-badge ${typeBadge}">${draft.type.toUpperCase()}</span>
                </div>
              </div>
              <div class="item-meta">
                ğŸ“… ${date} | ğŸ‘¥ ${draft.recipientType === 'all' ? 'Táº¥t cáº£ users' : draft.walletAddress}
              </div>
              <div class="item-message">${draft.message}</div>
              <div class="item-actions">
                ${draft.status === 'draft' ? `
                  <button class="btn-primary btn-small" onclick="editDraft('${draft._id}')">âœï¸ Sá»­a</button>
                  <button class="btn-success btn-small" onclick="sendDraft('${draft._id}')">ğŸ“¤ Gá»­i</button>
                ` : ''}
                <button class="btn-danger btn-small" onclick="deleteDraft('${draft._id}')">ğŸ—‘ï¸ XÃ³a</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<div class="response error"><strong>âŒ Lá»—i:</strong> ${err.message}</div>`;
      }
    }

    // Load sent notifications
    async function loadSentNotifications() {
      const container = document.getElementById('sentContainer');
      container.innerHTML = '<div class="loading"><span class="spinner"></span> Äang táº£i...</div>';

      try {
        const res = await fetch(`${notifApiBase}`);
        const data = await res.json();

        if (!res.ok) {
          container.innerHTML = `<div class="response error"><strong>âŒ Lá»—i</strong></div>`;
          return;
        }

        const { notifications = [] } = data;
        if (notifications.length === 0) {
          container.innerHTML = '<div class="response"><strong>KhÃ´ng cÃ³ thÃ´ng bÃ¡o</strong></div>';
          return;
        }

        let html = '<div class="items-list">';
        notifications.forEach(notif => {
          const date = new Date(notif.createdAt).toLocaleString('vi-VN');
          const typeBadge = `badge-${notif.type}`;
          html += `
            <div class="item-card">
              <div class="item-header">
                <div>
                  <div class="item-title">${notif.title}</div>
                  <span class="item-badge ${typeBadge}">${notif.type.toUpperCase()}</span>
                  <span class="item-badge">${notif.isRead ? 'âœ… ÄÃ£ Ä‘á»c' : 'â­• ChÆ°a Ä‘á»c'}</span>
                </div>
              </div>
              <div class="item-meta">
                ğŸ“… ${date} | ğŸ‘¤ ${notif.walletAddress}
              </div>
              <div class="item-message">${notif.message}</div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<div class="response error"><strong>âŒ Lá»—i:</strong> ${err.message}</div>`;
      }
    }

    // Load all notifications
    async function loadAllNotifications() {
      const container = document.getElementById('allNotificationsContainer');
      container.innerHTML = '<div class="loading"><span class="spinner"></span> Äang táº£i...</div>';

      try {
        const res = await fetch(`${notifApiBase}/all`);
        const data = await res.json();

        if (!res.ok) {
          container.innerHTML = `<div class="response error"><strong>âŒ Lá»—i: ${data.message}</strong></div>`;
          return;
        }

        const { notifications = [] } = data;
        if (notifications.length === 0) {
          container.innerHTML = '<div class="response"><strong>KhÃ´ng cÃ³ thÃ´ng bÃ¡o nÃ o</strong></div>';
          return;
        }

        // TÃ­nh thá»‘ng kÃª
        const totalNotif = notifications.length;
        const unreadNotif = notifications.filter(n => !n.isRead).length;
        const readNotif = notifications.filter(n => n.isRead).length;

        let html = `
          <div class="stats" style="margin-bottom: 20px;">
            <div class="stat-card">
              <div class="stat-number">${totalNotif}</div>
              <div class="stat-label">Tá»•ng ThÃ´ng bÃ¡o</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${readNotif}</div>
              <div class="stat-label">ÄÃ£ Äá»c</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${unreadNotif}</div>
              <div class="stat-label">ChÆ°a Äá»c</div>
            </div>
          </div>
          <div class="items-list">
        `;

        notifications.forEach(notif => {
          const date = new Date(notif.createdAt).toLocaleString('vi-VN');
          const typeBadge = `badge-${notif.type}`;
          const statusBadge = notif.isRead ? 'badge-sent' : 'badge-draft';
          
          // Kiá»ƒm tra isSystemNotification - náº¿u khÃ´ng cÃ³ thÃ¬ máº·c Ä‘á»‹nh false
          const isSystem = notif.isSystemNotification === true;
          const systemBadge = isSystem ? 'badge-warning' : 'badge-info';
          const systemText = isSystem ? 'ğŸ“¢ Há»‡ thá»‘ng' : 'ğŸ‘¤ CÃ¡ nhÃ¢n';
          // Hiá»ƒn thá»‹ recipient: há»‡ thá»‘ng = táº¥t cáº£ users, cÃ¡ nhÃ¢n = 1 user
          const recipientText = isSystem ? 'ğŸ“¢ Táº¥t cáº£ users' : `ğŸ‘¤ ${notif.walletAddress}`;
          
          html += `
            <div class="item-card ${notif.isRead ? '' : 'unread'}" style="${!notif.isRead ? 'border-left: 4px solid #667eea; background: #f9fafb;' : ''}">
              <div class="item-header">
                <div style="flex: 1;">
                  <div class="item-title">${notif.title}</div>
                  <div style="margin-top: 8px;">
                    <span class="item-badge ${typeBadge}">${notif.type.toUpperCase()}</span>
                    <span class="item-badge ${statusBadge}">${notif.isRead ? 'âœ… ÄÃ£ Ä‘á»c' : 'â­• ChÆ°a Ä‘á»c'}</span>
                    <span class="item-badge ${systemBadge}">${systemText}</span>
                  </div>
                </div>
              </div>
              <div class="item-meta">
                ğŸ“… ${date} | ${recipientText}
              </div>
              <div class="item-message">${notif.message}</div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<div class="response error"><strong>âŒ Lá»—i:</strong> ${err.message}</div>`;
      }
    }

    // Load stats
    async function loadStats() {
      const container = document.getElementById('statsContainer');
      container.innerHTML = '<div class="loading"><span class="spinner"></span> Äang táº£i...</div>';

      try {
        const res = await fetch(`${apiBase}/stats`);
        const data = await res.json();

        if (!res.ok) {
          container.innerHTML = `<div class="response error"><strong>âŒ Lá»—i</strong></div>`;
          return;
        }

        const { stats } = data;
        container.innerHTML = `
          <div class="stat-card">
            <div class="stat-number">${stats.totalDrafts}</div>
            <div class="stat-label">Tá»•ng Báº£n NhÃ¡p</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.draftCount}</div>
            <div class="stat-label">NhÃ¡p</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.scheduledCount}</div>
            <div class="stat-label">LÃªn Lá»‹ch</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.sentCount}</div>
            <div class="stat-label">ÄÃ£ Gá»­i</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.totalNotifications}</div>
            <div class="stat-label">Tá»•ng ThÃ´ng bÃ¡o</div>
          </div>
        `;
      } catch (err) {
        container.innerHTML = `<div class="response error"><strong>âŒ Lá»—i:</strong> ${err.message}</div>`;
      }
    }

    // Send draft
    async function sendDraft(draftId) {
      if (!confirm('Gá»­i báº£n nhÃ¡p nÃ y?')) return;

      try {
        const res = await fetch(`${apiBase}/${draftId}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const json = await res.json();
        if (res.ok) {
          alert('âœ… ' + json.message);
          loadDrafts();
        } else {
          alert('âŒ ' + json.message);
        }
      } catch (err) {
        alert('âŒ Lá»—i: ' + err.message);
      }
    }

    // Delete draft
    async function deleteDraft(draftId) {
      if (!confirm('XÃ³a báº£n nhÃ¡p nÃ y?')) return;

      try {
        const res = await fetch(`${apiBase}/${draftId}`, { method: 'DELETE' });
        const json = await res.json();
        if (res.ok) {
          alert('âœ… ' + json.message);
          loadDrafts();
        } else {
          alert('âŒ ' + json.message);
        }
      } catch (err) {
        alert('âŒ Lá»—i: ' + err.message);
      }
    }

    // Edit draft
    function editDraft(draftId) {
      alert('Chá»©c nÄƒng sá»­a sáº½ Ä‘Æ°á»£c cáº­p nháº­t sau');
      // TODO: Implement edit functionality
    }

    // Event listeners
    document.getElementById('loadDraftsBtn').addEventListener('click', loadDrafts);
    document.getElementById('loadAllNotificationsBtn').addEventListener('click', loadAllNotifications);
    document.getElementById('loadStatsBtn').addEventListener('click', loadStats);

    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = '/api/notification/ui';
    });

    // Load initial data
    loadDrafts();
    loadStats();
    loadAllNotifications();
  </script>
</body>
</html>
